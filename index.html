<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Wheel of Fortune</title>
  <script type="text/javascript" src="js/Winwheel.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
</head>

<body>
  <div class='header'>
    <img src="img/logo-sinfo.png" alt="SINFO 25" class='SINFO-logo' />
  </div>

  <div id="container">
    <div class="title">Lucky Wheel</div>

    <div class="row align-items-center">
      <div id="hacky" class="col  text-center">
        <img src="img/Hacky26.png" alt="hacky" id='hacky-image' />
      </div>

      <div class="col  text-center">
        <div id="wheel-canvas">
          <canvas id="canvas" width="434" height="434"></canvas>
        </div>
      </div>

      <div class="col  text-center">
        <table class="table prizes">
          <thead>
            <tr>
              <th colspan="2">Prize List</th>
              <th onclick="toggleValues()">#</th>
            </tr>
          </thead>
          <tbody id="prizes-list"></tbody>
        </table>
        <button style="margin: auto"class="toggleable" onclick="changeValues()">Save</button>
      </div>
    </div>

    <div class="row justify-content-center">
      <button class="btn btn-outline-primary col-4" id="spin-button" onClick="startSpin();"> Spin </button>
    </div>
  </div>
  <div class="footer">
    Made with ♥ at SINFO
  </div>
</body>
<script src="http://cdnjs.cloudflare.com/ajax/libs/p2.js/0.6.0/p2.min.js"></script>

<style>
  .input {
    width: 40px;
  }
   .toggleable {
     display: none;
   }
</style>

<script>
  let prizes = {
    0: {'id': 0, 'name': 'Abre\ncaricas', 'determinanteArtigo': "um", 'limit': 50, 'fillStyle': '#E69F00', 'times': 0},
    1: {
      'id': 1,
      'name': 'Bola\nanti-stress',
      'determinanteArtigo': "uma",
      'limit': 25,
      'fillStyle': '#00A3FF',
      'times': 0
    },
    2: {'id': 2, 'name': 'Saco', 'determinanteArtigo': "um", 'limit': 50, 'fillStyle': '#56B4E9', 'times': 0},
    3: {'id': 3, 'name': 'T-shirt', 'determinanteArtigo': "uma", 'limit': 20, 'fillStyle': '#CC79A7', 'times': 0},
    4: {'id': 4, 'name': 'Rato\nGaming', 'determinanteArtigo': "um", 'limit': 2, 'fillStyle': '#07BF23', 'times': 0},
    5: {'id': 5, 'name': 'Head\nphones', 'determinanteArtigo': "uns", 'limit': 1, 'fillStyle': '#F0E442', 'times': 0},
    6: {'id': 6, 'name': 'Óculos\nVR', 'determinanteArtigo': "uns", 'limit': 1, 'fillStyle': '#D55E00', 'times': 0},
  };

  let segments = Object.values(prizes);
  let chosenPrize;
  let wheelSpinning = false;
  let theWheel = new Winwheel({
    'numSegments': segments.length,   // Specify number of segments.
    'outerRadius': 212,      // Set radius to so wheel fits the background.
    'innerRadius': 120,      // Set inner radius to make wheel hollow.
    'textFontSize': 16,       // Set font size accordingly.
    'textMargin': 0,        // Take out default margin.
    'segments': segments, // Define segments including colour and text.
    'animation':               // Define spin to stop animation.
    {
      'type': 'spinToStop',
      'duration': 10,
      'spins': 2,
      'callbackSound' : playSound,    // Specify function to call when sound is to be triggered.
      'soundTrigger'  : 'pin',         // Pins trigger the sound for this animation.
      'callbackFinished': alertPrize
    },
    'pins' :    // Display pins, and if desired specify the number.
      {
        'number' : 16
      }
  });

  createTable();

  function createTable() {
    document.getElementById('prizes-list').innerHTML = '';
    for (var i = 0; i < Object.values(prizes).length; i++) {
      document.getElementById('prizes-list').insertAdjacentHTML('beforeend', `
          <tr>
          <td style="background-color:${prizes[i].fillStyle}"></td>
          <td class="true">${prizes[i].name}</td>
          <td class="toggleable true">
            <input type="number" class="input" id="input-${i}" value="${prizes[i].limit - prizes[i].times}">
          </td>
          </tr>`);
    }
  }

  function choosePrize() {
    let list = Object.values(prizes).map(prize => Array(prize.limit - prize.times).fill(prize)).flat(1);
    let index = Math.floor(Math.random() * list.length);
    return list[index];
  }

  function startSpin() {
    // Ensure that spinning can't be clicked again while already running.
    if (wheelSpinning == false) {

      chosenPrize = choosePrize();
      chosenPrize.times += 1;

      // Important thing is to set the stopAngle of the animation before stating the spin.
      let stopAt = (chosenPrize.id + 0.5)*360/Object.values(prizes).length;
      theWheel.animation.stopAngle = stopAt;

      // Begin the spin animation by calling startAnimation on the wheel object.
      theWheel.startAnimation();

      // Set to true so that power can't be changed and spin button re-enabled during
      // the current animation. The user will have to reset before spinning again.
      wheelSpinning = true;
    }
  }

  function alertPrize() {
    let audio = new Audio('sound/horn.mp3');
    audio.pause();
    audio.currentTime = 0;
    audio.play();
    audio.play();

    alert("Ganhaste " + chosenPrize.determinanteArtigo + " " + chosenPrize.name.replace("\n", " ").toLowerCase());
    resetWheel()
  }

  function resetWheel() {
    theWheel.stopAnimation(false);  // Stop the animation, false as param so does not call callback function.
    theWheel.rotationAngle = 0;     // Re-set the wheel angle to 0 degrees.
    theWheel.animation.segments = segments;
    theWheel.animation.numSegments = segments.length;
    theWheel.draw();                // Call draw to render changes to the wheel.
    wheelSpinning = false;          // Reset to false to power buttons and spin can be clicked again.
    createTable();
  }

  function changeValues() {
    Object.values(prizes).forEach(prize => {
      prize.times = prize.limit - Number(document.getElementById(`input-${prize.id}`).value);
    });
    toggleValues();
  }

  function toggleValues() {
    let values = document.getElementsByClassName('toggleable');
    Array.from(values).forEach((v) => {
      if (v.style.display === "none") {
        v.style.display = "block";
      } else {
        v.style.display = "none";
      }
    });
  }

  function playSound() {
    let audio = new Audio('sound/tick.mp3');
    // Stop and rewind the sound (stops it if already playing).
    audio.pause();
    audio.currentTime = 0;

    // Play the sound.
    audio.play();
  }
</script>

</html>
